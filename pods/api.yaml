---
apiVersion: "extensions/v1beta1"
kind: "Deployment"
metadata:
  name: "api"
  namespace: "default"
  labels:
    app: "api"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: "api"
  template:
    metadata:
      labels:
        app: "api"
    spec:
      containers:
      - name: "api"
        image: "whatsaranjit/k8s_connect:v1"
        imagePullPolicy: Always
        env:
        - name: dbhost
          valueFrom:
            configMapKeyRef:
              name: db
              key: ip
        - name: port
          value: '8081'
      - name: "consul"
        image: "consul"
        env:
        - name: CONSUL_SERVER
          valueFrom:
            configMapKeyRef:
              name: consul
              key: ip
        - name: MY_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: "CONSUL_LOCAL_CONFIG"
          value:
            "{
              \"leave_on_terminate\": true,
              \"bind_addr\": \"$(MY_POD_IP)\",
              \"client_addr\": \"$(MY_POD_IP)\",
              \"retry_join\": [\"$(CONSUL_SERVER)\"],
              \"service\": {
                \"name\": \"api\",
                \"port\": 8081,
                \"checks\": [{
                  \"http\": \"http://localhost:8081/api\",
                  \"interval\": \"10s\",
                  \"timeout\": \"1s\"
                }],
                \"connect\": {
                  \"proxy\": {
                    \"config\": {
                      \"upstreams\": [{
                        \"destination_name\": \"db\",
                        \"local_bind_port\": 8082
                      }]
                    }
                  }
                }
              }
            }"
